<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="iEnergy employee database" />
  <title>iEnergy | Employee Database</title>
  <link rel="stylesheet" href="../home.css?v=2" />
  <style>
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
    .field { flex: 1 1 320px; }
    label { display:block; margin: 0 0 6px; color: rgba(233,238,252,0.80); font-size: 13px; }
    input[type="text"] {
      width: 100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      outline: none;
    }
    input[type="text"]:focus { border-color: rgba(47,107,255,0.60); }
    .btn {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 11px 14px;
      border-radius: 12px;
      border: 1px solid rgba(47,107,255,0.45);
      background: rgba(47,107,255,0.12);
      color: var(--text);
      cursor: pointer;
      font-weight: 700;
      text-decoration: none;
    }
    .btn.secondary { border-color: rgba(255,255,255,0.18); background: rgba(255,255,255,0.04); }
    .btn:disabled { opacity: 0.55; cursor: not-allowed; }
    .note { margin: 10px 0 0; color: var(--muted); font-size: 12.5px; line-height: 1.45; }
    .table-wrap { margin-top: 14px; overflow:auto; border: 1px solid var(--line); border-radius: 14px; }
    table { width: 100%; border-collapse: collapse; min-width: 760px; }
    th, td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.08); font-size: 13px; }
    th { text-align: left; position: sticky; top: 0; background: rgba(18,27,46,0.98); z-index: 1; }
    td { color: rgba(233,238,252,0.90); }
    .muted { color: rgba(233,238,252,0.65); }
    .alert { margin-top: 10px; color: rgba(255,180,180,0.95); }
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
</head>
<body>
  <main class="container">
    <header class="hero">
      <div class="hero-text">
        <div class="pill">Application</div>
        <h1>Employee Database</h1>
        <p class="tagline">Browse and search employees (source: <code>data/employees.xlsx</code>).</p>
        <p style="margin:12px 0 0; display:flex; gap:10px; flex-wrap:wrap;">
          <a class="btn secondary" href="../index.html">← Back to Home</a>
          <a class="btn" href="../data/employees.xlsx" download>Download Excel</a>
        </p>
      </div>
      <img class="hero-logo" src="../logo.jpg" alt="iEnergy logo" />
    </header>

    <section class="section">
      <h2>Search</h2>
      <p class="section-sub">Filter by employee code, name, or position.</p>

      <div class="row">
        <div class="field">
          <label for="q">Search</label>
          <input id="q" type="text" autocomplete="off" placeholder="e.g., 10023, Ahmed, Accountant" />
        </div>
        <button id="btnReload" class="btn" type="button">Reload</button>
      </div>
      <p class="note" id="status"></p>
      <div id="alert" class="alert" style="display:none;"></div>

      <div class="table-wrap" id="tableWrap" style="display:none;">
        <table>
          <thead>
            <tr>
              <th>Employee Code</th>
              <th>Name</th>
              <th>Position</th>
              <th>Hiring Date</th>
              <th>Basic Gross Salary</th>
              <th>Basic Social Insurance Salary</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <p class="note muted" id="count" style="display:none;"></p>
    </section>

    <footer class="footer">
      <small>© <span id="year"></span> iEnergy. Internal use.</small>
    </footer>
  </main>

  <script>
    document.getElementById('year').textContent = String(new Date().getFullYear());

    const $ = (id) => document.getElementById(id);
    const nf = new Intl.NumberFormat('en-US');

    let cache = null; // { records, map }

    function normalizeHeader(s) {
      return String(s ?? '').toLowerCase().replace(/[^a-z0-9]+/g, '');
    }

    function pickHeader(headers, candidates) {
      const byNorm = new Map();
      for (const h of headers) byNorm.set(normalizeHeader(h), h);
      for (const c of candidates) {
        const k = normalizeHeader(c);
        if (byNorm.has(k)) return byNorm.get(k);
      }
      for (const c of candidates) {
        const k = normalizeHeader(c);
        for (const [hn, raw] of byNorm.entries()) {
          if (hn.includes(k) || k.includes(hn)) return raw;
        }
      }
      return null;
    }

    function formatMaybeNumber(v) {
      if (v === null || v === undefined || v === '') return '';
      if (typeof v === 'number' && Number.isFinite(v)) return nf.format(v);
      const asNum = Number(String(v).replace(/,/g, ''));
      if (!Number.isNaN(asNum) && String(v).trim() !== '') return nf.format(asNum);
      return String(v);
    }

    function formatDate(v) {
      if (v === null || v === undefined || v === '') return '';
      if (v instanceof Date && !isNaN(v.getTime())) {
        const y = v.getFullYear();
        const m = String(v.getMonth() + 1).padStart(2, '0');
        const d = String(v.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      }
      if (typeof v === 'number' && Number.isFinite(v) && window.XLSX?.SSF?.parse_date_code) {
        const dc = XLSX.SSF.parse_date_code(v);
        if (dc && dc.y && dc.m && dc.d) {
          return `${dc.y}-${String(dc.m).padStart(2, '0')}-${String(dc.d).padStart(2, '0')}`;
        }
      }
      return String(v);
    }

    function showAlert(msg) {
      $('alert').textContent = msg;
      $('alert').style.display = 'block';
    }

    function clearAlert() {
      $('alert').style.display = 'none';
      $('alert').textContent = '';
    }

    async function loadEmployees(force = false) {
      if (cache && !force) return cache;
      if (!window.XLSX) throw new Error('XLSX library failed to load.');

      clearAlert();
      $('status').textContent = 'Loading employees.xlsx…';
      $('btnReload').disabled = true;

      const resp = await fetch('../data/employees.xlsx', { cache: 'no-store' });
      if (!resp.ok) throw new Error(`Failed to load employees.xlsx (HTTP ${resp.status}).`);
      const buf = await resp.arrayBuffer();

      const wb = XLSX.read(buf, { type: 'array', cellDates: true });
      const sheetName = wb.SheetNames[0];
      if (!sheetName) throw new Error('employees.xlsx has no worksheets.');
      const ws = wb.Sheets[sheetName];
      const records = XLSX.utils.sheet_to_json(ws, { defval: '', raw: true });
      if (!records.length) throw new Error('employees.xlsx has no data rows.');

      const headers = Object.keys(records[0]);
      const map = {
        code: pickHeader(headers, ['Employee Code', 'Emp Code', 'EmpCode', 'Code', 'EmployeeID', 'ID', 'employee_code']),
        name: pickHeader(headers, ['Name', 'Employee Name', 'Full Name', 'Employee']),
        position: pickHeader(headers, ['Position', 'Job Title', 'Title', 'Designation', 'Role']),
        hireDate: pickHeader(headers, ['Hiring Date', 'Hire Date', 'Joining Date', 'Start Date']),
        basicGross: pickHeader(headers, ['Basic Gross Salary', 'Basic Gross', 'Gross Basic', 'Basic Salary']),
        basicSI: pickHeader(headers, ['Basic Social Insurance Salary', 'Basic SI Salary', 'Insurable Salary', 'Social Insurance Salary', 'Basic Insurable Salary'])
      };

      cache = { records, map, sheetName };
      $('status').textContent = `Loaded ${records.length} records from sheet “${sheetName}”.`;
      $('btnReload').disabled = false;
      return cache;
    }

    function getField(row, header) {
      if (!header) return '';
      return row?.[header] ?? '';
    }

    function rowMatches(row, map, q) {
      if (!q) return true;
      const hay = [
        getField(row, map.code),
        getField(row, map.name),
        getField(row, map.position)
      ].map(v => String(v ?? '').toLowerCase()).join(' | ');
      return hay.includes(q);
    }

    function renderTable(records, map, q) {
      const tbody = $('tbody');
      tbody.innerHTML = '';

      const qNorm = String(q ?? '').trim().toLowerCase();
      const filtered = records.filter(r => rowMatches(r, map, qNorm));

      const frag = document.createDocumentFragment();
      for (const r of filtered) {
        const tr = document.createElement('tr');
        const td = (text) => {
          const c = document.createElement('td');
          c.textContent = text;
          return c;
        };

        tr.appendChild(td(String(getField(r, map.code) ?? '')));
        tr.appendChild(td(String(getField(r, map.name) ?? '')));
        tr.appendChild(td(String(getField(r, map.position) ?? '')));
        tr.appendChild(td(formatDate(getField(r, map.hireDate))));
        tr.appendChild(td(formatMaybeNumber(getField(r, map.basicGross))));
        tr.appendChild(td(formatMaybeNumber(getField(r, map.basicSI))));
        frag.appendChild(tr);
      }

      tbody.appendChild(frag);
      $('tableWrap').style.display = 'block';
      $('count').style.display = 'block';
      $('count').textContent = `Showing ${filtered.length} of ${records.length} employees.`;
    }

    async function init(force = false) {
      try {
        const { records, map } = await loadEmployees(force);
        renderTable(records, map, $('q').value);
      } catch (e) {
        showAlert(e?.message ? String(e.message) : 'Unexpected error while loading employees.xlsx');
        $('status').textContent = '';
        $('tableWrap').style.display = 'none';
        $('count').style.display = 'none';
      } finally {
        $('btnReload').disabled = false;
      }
    }

    $('q').addEventListener('input', () => {
      if (!cache) return;
      renderTable(cache.records, cache.map, $('q').value);
    });

    $('btnReload').addEventListener('click', () => init(true));

    // initial load
    init(false);
  </script>
</body>
</html>
